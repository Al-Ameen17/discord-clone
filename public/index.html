<!doctype html>
<html>
    <head>
        <title>DihCord</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2848/2848.wav"></audio>
        
        <div class="servers-list">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-right: 10px;">
                <h3>Rooms</h3>
                <button onclick="createRoom()" style="background: none; border: none; color: #949ba4; cursor: pointer; font-size: 16px;">+</button>
            </div>
            <ul id="rooms-list"></ul>

            <h3 style="margin-top: 20px;">Direct Messages</h3>
            <ul id="dms-list"></ul>

            <h3 style="margin-top: 20px;">Online Users</h3>
            <ul id="users-list"></ul>

            <div class="voice-channel">
                <div class="voice-header">VOICE CHANNELS</div>
                <button id="join-voice-btn" class="voice-btn" onclick="joinVoice()">
                    üîä General Voice
                </button>
                
                <div id="voice-controls" style="display:none; margin-top:5px; gap:5px; flex-wrap:wrap;">
                    <button class="control-btn" onclick="toggleMute()" id="mute-btn">üé§ Mute</button>
                    <button class="control-btn" onclick="shareScreen()" id="screen-btn" style="background:#5865F2;">üñ•Ô∏è Share</button>
                    <button class="control-btn btn-danger" onclick="leaveVoice()">‚úñ Leave</button>
                </div>
            </div>

            <div class="user-panel">
                <div class="user-info" onclick="triggerAvatarUpload()" style="cursor: pointer;" title="Change Avatar">
                    <img id="current-user-avatar" src="" alt="Avatar">
                    <span id="current-user-name">Loading...</span>
                </div>
                
                <input type="file" id="update-avatar-input" accept="image/*" style="display:none;">
                
                <button onclick="logout()" class="logout-btn" title="Log Out">üö™</button>
            </div>
        </div>

        <div class="content">
            <button id="menu-btn" onclick="toggleSidebar()" style="display:none;">‚ò∞</button>
            
            <div id="message-container">
                <p><strong>System:</strong> Welcome to the server!</p>
            </div>

            <div class="input-area">
                <div id="typing-indicator"></div> 
                
                <div id="reply-preview">
                    <span id="reply-text">Replying to...</span>
                    <button onclick="cancelReply()" style="background:none; border:none; color:#dbdee1; cursor:pointer;">‚úñ</button>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="document.getElementById('file-input').click()" class="toolbar-btn">üìé Media</button>
                    <button id="emoji-btn" onclick="toggleEmojiPicker()" class="toolbar-btn">üòÄ Emoji</button>
                </div>

                <input type="file" id="file-input" accept="image/*,video/*" style="display: none;" onchange="uploadMedia()">
                
                <input type="text" id="message-input" placeholder="Message #general...">
            </div>
        </div>

        <div id="profile-modal" onclick="closeProfile(event)">
            <div class="profile-card">
                <div class="close-modal" onclick="document.getElementById('profile-modal').style.display='none'">‚úï</div>
                <div class="profile-banner"></div>
                <img id="modal-avatar" class="profile-avatar" src="">
                
                <h2 id="modal-name" class="profile-name">User</h2>
                <div id="modal-status" class="profile-status">online</div>
                
                <div class="profile-bio">
                    <strong>About Me:</strong><br>
                    <span id="modal-bio">...</span>
                </div>

                <div id="edit-controls" style="display:none; padding: 10px;">
                    <input type="text" id="edit-bio-input" placeholder="New Bio..." style="width:70%; padding:5px; border-radius:5px; border:none;">
                    <select id="edit-status-input" style="padding:5px; border-radius:5px;">
                        <option value="online">üü¢ Online</option>
                        <option value="idle">üåô Idle</option>
                        <option value="dnd">‚õî DND</option>
                    </select>
                    <button onclick="saveProfile()" style="margin-top:10px; padding:5px 15px; background:var(--accent); color:white; border:none; border-radius:5px; cursor:pointer;">Save</button>
                </div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        
        <script type="module">
            import { EmojiButton } from 'https://unpkg.com/@joeattardi/emoji-button@4.6.4/dist/index.js';

            // --- SECURITY & INITIALIZATION ---
            // 1. Check for Token on startup
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');           
            const avatar = localStorage.getItem('avatar'); 
            
            if (!token || !username) {
                window.location.href = '/login.html';
            }

            // 2. Connect to Socket.IO with Token Authentication
            window.socket = io({
                auth: { token: token } 
            });

            let currentRoom = localStorage.getItem('lastRoom') || 'general';
            let unreadDMs = {}; 

            // --- IMMEDIATE STARTUP ---
            updateRoomUI(currentRoom);

            // --- HELPER: Get Headers for API Calls ---
            function getAuthHeaders() {
                return { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                };
            }

            // --- SETUP EMOJI PICKER ---
            const picker = new EmojiButton({
                position: 'top-start',
                theme: 'dark', 
                autoHide: false
            });

            picker.on('emoji', selection => {
                const input = document.getElementById('message-input');
                input.value += selection.emoji;
                input.focus();
            });

            window.toggleEmojiPicker = function() {
                const trigger = document.getElementById('emoji-btn');
                picker.togglePicker(trigger);
            }

            // --- CORE CHAT LOGIC ---
            window.joinRoom = function(roomName) {
                currentRoom = roomName;
                localStorage.setItem('lastRoom', roomName);
                updateRoomUI(roomName); 
                document.getElementById('message-container').innerHTML = '';
                socket.emit('join room', roomName);
            }

            // --- DM SYSTEM ---
            const savedDMs = JSON.parse(localStorage.getItem('openDMs')) || [];
            
            function renderDMs() {
                const list = document.getElementById('dms-list');
                list.innerHTML = '';
                savedDMs.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'server-name';
                    
                    // Check for unread messages
                    const count = unreadDMs[user] || 0;
                    const badge = count > 0 ? `<span class="notification-badge" style="background:var(--danger); padding:2px 6px; border-radius:10px; font-size:0.8em; margin-left:5px;">${count}</span>` : '';
                    
                    li.innerHTML = `<a href="#" onclick="startDM('${user}')">@ ${user} ${badge}</a>`;
                    
                    // Add a tiny "x" to close DM
                    const closeBtn = document.createElement('span');
                    closeBtn.innerHTML = '√ó';
                    closeBtn.style.cssText = 'float:right; cursor:pointer; color:#666; padding:0 5px;';
                    closeBtn.onclick = (e) => {
                        e.stopPropagation(); // Don't trigger the click to join
                        closeDM(user);
                    };
                    li.firstChild.appendChild(closeBtn);
                    
                    list.appendChild(li);
                });
            }

            window.startDM = function(targetUser) {
                if (!savedDMs.includes(targetUser)) {
                    savedDMs.push(targetUser);
                    localStorage.setItem('openDMs', JSON.stringify(savedDMs));
                    renderDMs();
                }
                if (unreadDMs[targetUser]) {
                    unreadDMs[targetUser] = 0;
                    renderDMs();
                }
                const roomName = ['dm', username, targetUser].sort().join('_');
                joinRoom(roomName);
            }

            window.closeDM = function(targetUser) {
                const index = savedDMs.indexOf(targetUser);
                if (index > -1) {
                    savedDMs.splice(index, 1);
                    localStorage.setItem('openDMs', JSON.stringify(savedDMs));
                    renderDMs();
                    if (currentRoom.includes(targetUser)) {
                        joinRoom('general'); 
                    }
                }
            }

            // --- USER PANEL LOGIC ---
            document.getElementById('current-user-name').innerText = username;
            document.getElementById('current-user-avatar').src = avatar;

            window.logout = function() {
                if (confirm("Are you sure you want to log out?")) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    localStorage.removeItem('avatar');
                    localStorage.removeItem('lastRoom');
                    window.location.href = '/login.html';
                }
            }

            // --- AVATAR UPLOAD LOGIC ---
            window.triggerAvatarUpload = function() {
                document.getElementById('update-avatar-input').click();
            }

            window.changeAvatar = async function() {
                const fileInput = document.getElementById('update-avatar-input');
                if (fileInput.files.length === 0) return;

                const formData = new FormData();
                formData.append('avatar', fileInput.files[0]);

                try {
                    const uploadRes = await fetch('/upload-avatar', { 
                        method: 'POST', 
                        headers: { 'Authorization': 'Bearer ' + token }, 
                        body: formData 
                    });
                    const uploadData = await uploadRes.json();
                    
                    if (uploadData.success) {
                        const newAvatarUrl = uploadData.filePath;
                        await fetch('/update-user-avatar', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({ avatarUrl: newAvatarUrl })
                        });

                        localStorage.setItem('avatar', newAvatarUrl);
                        document.getElementById('current-user-avatar').src = newAvatarUrl;
                        alert("Avatar updated!");
                        location.reload();
                    }
                } catch (err) {
                    alert("Failed to update avatar");
                }
            }
            
            const avatarInput = document.getElementById('update-avatar-input');
            if(avatarInput) {
                avatarInput.addEventListener('change', window.changeAvatar);
            }

            // --- REPLY LOGIC ---
            let replyingTo = null; 

            window.startReply = function(id, user, text) {
                replyingTo = { id, user, text };
                const bar = document.getElementById('reply-preview');
                const label = document.getElementById('reply-text');
                bar.style.display = 'flex';
                label.innerHTML = `Replying to <strong>@${user}</strong>`;
                document.getElementById('message-input').focus();
            }

            window.cancelReply = function() {
                replyingTo = null;
                document.getElementById('reply-preview').style.display = 'none';
            }

            function updateRoomUI(roomName) {
                const input = document.getElementById('message-input');
                if (roomName.startsWith('dm_')) {
                    const parts = roomName.split('_');
                    const otherUser = parts.find(p => p !== 'dm' && p !== username);
                    input.placeholder = `Private message to @${otherUser}...`;
                } else {
                    input.placeholder = `Message #${roomName}...`;
                }
            }

            // --- MEDIA UPLOAD ---
            window.uploadMedia = function() {
                const fileInput = document.getElementById('file-input');
                const file = fileInput.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert("File is too large! Max 10MB.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const messageData = { user: username, text: e.target.result, avatar: avatar };
                        socket.emit('chat message', messageData);
                    };
                    reader.readAsDataURL(file); 
                }
                fileInput.value = ''; 
            }

            // --- PROFILE & STATUS LOGIC ---
            window.viewProfile = async function(targetUser) {
                const res = await fetch('/get-profile', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ username: targetUser })
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('modal-name').innerText = data.username;
                    document.getElementById('modal-avatar').src = data.avatar;
                    document.getElementById('modal-bio').innerText = data.bio;
                    document.getElementById('modal-status').innerText = data.status.toUpperCase();
                    
                    const isMe = (targetUser === username);
                    document.getElementById('edit-controls').style.display = isMe ? 'block' : 'none';
                    if (isMe) {
                        document.getElementById('edit-bio-input').value = data.bio;
                        document.getElementById('edit-status-input').value = data.status;
                    }
                    document.getElementById('profile-modal').style.display = 'flex';
                }
            }

            window.saveProfile = async function() {
                const newBio = document.getElementById('edit-bio-input').value;
                const newStatus = document.getElementById('edit-status-input').value;

                await fetch('/update-profile', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ bio: newBio, status: newStatus })
                });

                document.getElementById('profile-modal').style.display = 'none';
                alert("Profile Updated!");
            }

            window.closeProfile = function(e) {
                if (e.target.id === 'profile-modal') {
                    document.getElementById('profile-modal').style.display = 'none';
                }
            }

            // --- VOICE CHAT & SCREEN SHARE ---
            const voiceGrid = document.createElement('div'); 
            document.body.append(voiceGrid);
            
            let myPeer;
            let myStream;
            let myScreenStream; // NEW: Track screen stream
            const peers = {}; 

            window.joinVoice = function() {
                const btn = document.getElementById('join-voice-btn');
                const controls = document.getElementById('voice-controls');
                
                const peerId = 'dihcord-' + username.replace(/[^a-zA-Z0-9]/g, '') + '-' + Math.floor(Math.random()*1000);
                myPeer = new Peer(peerId);

                myPeer.on('open', id => {
                    navigator.mediaDevices.getUserMedia({
                        video: false, 
                        audio: true
                    }).then(stream => {
                        myStream = stream;
                        addMediaStream(document.createElement('audio'), stream, true); 

                        myPeer.on('call', call => {
                            call.answer(stream); 
                            const audio = document.createElement('audio');
                            call.on('stream', userVideoStream => {
                                addMediaStream(audio, userVideoStream);
                            });
                        });

                        socket.emit('join-voice', 'general-voice', id);
                        
                        btn.classList.add('voice-active');
                        btn.innerText = "üîä Connected";
                        controls.style.display = 'flex';

                        socket.on('user-connected-voice', (userId) => {
                            connectToNewUser(userId, stream);
                        });
                        
                        socket.on('user-disconnected-voice', (userId) => {
                            if (peers[userId]) peers[userId].close();
                        });

                    }).catch(err => {
                        alert("Could not access microphone! " + err);
                    });
                });
            }

            // NEW: Screen Sharing Logic
            window.shareScreen = function() {
                if (myScreenStream) {
                    // Stop Sharing
                    myScreenStream.getTracks().forEach(track => track.stop());
                    myScreenStream = null;
                    document.getElementById('screen-btn').innerText = "üñ•Ô∏è Share";
                    document.getElementById('screen-btn').style.background = "#5865F2";
                    return;
                }

                // Start Sharing
                navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: false 
                }).then(stream => {
                    myScreenStream = stream;
                    document.getElementById('screen-btn').innerText = "üõë Stop";
                    document.getElementById('screen-btn').style.background = "#da373c";

                    stream.getVideoTracks()[0].onended = () => { window.shareScreen(); };

                    // Broadcast screen to peers
                    Object.keys(peers).forEach(userId => {
                        myPeer.call(userId, stream);
                    });

                }).catch(err => { console.error("Screen share failed", err); });
            }

            window.leaveVoice = function() {
                socket.emit('leave-voice', 'general-voice', myPeer.id);
                socket.off('user-connected-voice');
                socket.off('user-disconnected-voice');
                if(myPeer) myPeer.destroy();
                if(myStream) myStream.getTracks().forEach(track => track.stop());
                if(myScreenStream) myScreenStream.getTracks().forEach(track => track.stop());

                const btn = document.getElementById('join-voice-btn');
                btn.classList.remove('voice-active');
                btn.innerText = "üîä General Voice";
                document.getElementById('voice-controls').style.display = 'none';
                voiceGrid.innerHTML = '';
            }

            window.toggleMute = function() {
                if(myStream) {
                    const track = myStream.getAudioTracks()[0];
                    track.enabled = !track.enabled;
                    document.getElementById('mute-btn').innerText = track.enabled ? "üé§ Mute" : "üî¥ Unmute";
                }
            }

            function connectToNewUser(userId, stream) {
                const call = myPeer.call(userId, stream);
                const audio = document.createElement('audio');
                call.on('stream', userVideoStream => {
                    addMediaStream(audio, userVideoStream);
                });
                call.on('close', () => { audio.remove(); });
                peers[userId] = call;
            }

            // UPDATED: Handle both Audio and Video (Screen Share)
            function addMediaStream(element, stream, isMe = false) {
                element.srcObject = stream;
                element.addEventListener('loadedmetadata', () => { element.play(); });
                if(isMe) element.muted = true; 
                
                // If it's a video track (Screen share), style it
                if (stream.getVideoTracks().length > 0) {
                    element = document.createElement('video');
                    element.srcObject = stream;
                    element.autoplay = true;
                    element.style.width = "300px";
                    element.style.position = "fixed";
                    element.style.bottom = "20px";
                    element.style.right = "20px";
                    element.style.borderRadius = "10px";
                    element.style.border = "2px solid var(--accent)";
                    element.style.zIndex = "2000";
                    // Make it draggable or clickable to close in future versions
                    element.onclick = () => element.remove(); 
                }

                voiceGrid.append(element);
            }
            
            socket.on('status update', (data) => {
                console.log(data.username + " is now " + data.status);
            });

           function addMessageToScreen(msg) {
                const container = document.getElementById('message-container');
                let item = document.getElementById(`msg-${msg._id}`);
                const isUpdate = !!item; 

                let previousElement;
                if (isUpdate) {
                    previousElement = item.previousElementSibling;
                } else {
                    previousElement = container.lastElementChild;
                }

                let isGrouped = false;
                if (previousElement && previousElement.dataset.user === msg.user) {
                    const prevTime = parseInt(previousElement.dataset.timestamp);
                    const thisTime = new Date(msg.timestamp || Date.now()).getTime();
                    if (thisTime - prevTime < 5 * 60 * 1000) {
                        isGrouped = true;
                    }
                }

                if (!item) {
                    item = document.createElement('div');
                    item.id = `msg-${msg._id}`;
                    item.dataset.timestamp = new Date(msg.timestamp || Date.now()).getTime();
                }
                item.dataset.user = msg.user; 

                const isMe = msg.user === username;
                const isAdmin = localStorage.getItem('username') === 'Sergslow';
                const timeString = new Date(msg.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const fullDateString = new Date(msg.timestamp || Date.now()).toLocaleString();

                let messageBody = msg.text; 
                const isVideo = msg.text.startsWith('data:video') || /\.(mp4|webm|ogg)$/i.test(msg.text);
                const isImage = msg.text.startsWith('data:image') || /\.(jpeg|jpg|gif|png|webp)$/i.test(msg.text);

                if (isVideo) messageBody = `<video src="${msg.text}" controls class="media-attachment"></video>`;
                else if (isImage) messageBody = `<img src="${msg.text}" class="media-attachment">`;

                const editedHtml = msg.edited ? `<span class="edited-tag">(edited)</span>` : '';

                let replyHtml = '';
                if (msg.replyTo) {
                    replyHtml = `
                        <div class="reply-quote" onclick="scrollToMessage('${msg.replyTo.id}')">
                            <span style="font-weight:bold; margin-right:5px;">@${msg.replyTo.user}</span>
                            <span style="opacity:0.8; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; max-width:200px;">${msg.replyTo.text}</span>
                        </div>`;
                    isGrouped = false; 
                }

                let actionButtons = `<div class="msg-actions">`;
                actionButtons += `<button class="action-btn" onclick="startReply('${msg._id}', '${msg.user}', '${msg.text.replace(/'/g, "\\'")}')">‚Ü©Ô∏è</button>`;
                if (isMe || isAdmin) {
                    if (isMe) actionButtons += `<button class="action-btn" onclick="editMessage('${msg._id}', '${msg.text.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>`;
                    actionButtons += `<button class="action-btn" onclick="deleteMessage('${msg._id}')" style="color:var(--danger);">üóëÔ∏è</button>`;
                }
                actionButtons += `</div>`;

                let reactionsHtml = '<div style="display:flex; gap:5px; margin-top:5px;">';
                const emojis = ['üëç', 'üòÇ', 'üî•', '‚ù§Ô∏è'];
                emojis.forEach(emoji => {
                    const users = (msg.reactions && msg.reactions[emoji]) ? msg.reactions[emoji] : [];
                    const activeClass = users.includes(username) ? 'active-reaction' : '';
                    const countDisplay = users.length > 0 ? `<span style="margin-left:4px; font-size:0.8em;">${users.length}</span>` : '';
                    reactionsHtml += `<button onclick="sendReaction('${msg._id}', '${emoji}')" class="reaction-btn ${activeClass}">${emoji} ${countDisplay}</button>`;
                });
                reactionsHtml += '</div>';

                if (isGrouped) {
                    item.className = "message-row msg-compact";
                    item.innerHTML = `
                        <div class="timestamp-hover">${timeString}</div>
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center;">
                                <div style="color:var(--text-normal); line-height:1.4; flex:1;">${messageBody} ${editedHtml}</div>
                                ${actionButtons}
                            </div>
                            ${reactionsHtml}
                        </div>
                    `;
                } else {
                    item.className = "message-row msg-header";
                    const userAvatar = msg.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${msg.user}`;
                    
                    item.innerHTML = `
                        <img src="${userAvatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; margin-top:2px;">
                        <div style="flex: 1;">
                            ${replyHtml}
                            <div style="display: flex; align-items: center; margin-bottom: 2px;">
                                <strong style="color: var(--text-header); cursor:pointer;" onclick="viewProfile('${msg.user}')">${msg.user}</strong>
                                <span style="font-size: 0.75em; color: var(--text-muted);" title="${fullDateString}">${timeString}</span>
                                ${actionButtons}
                            </div>
                            <div style="color: var(--text-normal); line-height: 1.4;">
                                ${messageBody} ${editedHtml}
                            </div>
                            ${reactionsHtml} 
                        </div>
                    `;
                }

                if (!isUpdate) {
                    container.appendChild(item);
                    container.scrollTop = container.scrollHeight;
                    if (container.children.length > 100) {
                        container.removeChild(container.firstElementChild);
                    }
                }
            }

            window.editMessage = function(id, oldText) {
                const newText = prompt("Edit your message:", oldText);
                if (newText && newText !== oldText) {
                    socket.emit('edit message', { id, newText });
                }
            }

            // --- SOCKET LISTENERS ---
            socket.on('connect', () => {
                console.log(">> Connected. Authenticated as:", username);
                socket.emit('user joined'); 
                socket.emit('join room', currentRoom);
            });
            
            socket.on('connect_error', (err) => {
                console.error("Connection Error:", err.message);
                if (err.message === "Authentication error") {
                    logout(); 
                }
            });

            socket.on('chat message', function(msg) {
                addMessageToScreen(msg);
                if (msg.user !== username) {
                    const audio = document.getElementById('notify-sound');
                    if(audio) audio.play().catch(e => {}); 
                }
            });

            socket.on('load history', function(history) {
                history.forEach(addMessageToScreen);
            });

            socket.on('update message', (updatedMsg) => {
                addMessageToScreen(updatedMsg);
            });

            socket.on('delete message', (id) => {
                const element = document.getElementById(`msg-${id}`);
                if (element) element.remove();
            });

            socket.on('new room', (name) => {
                addRoomToSidebar(name);
            });

            // UPDATED: DM Notification
            socket.on('dm notification', (data) => {
                if (currentRoom.includes(data.sender)) return; 
                
                if (!unreadDMs[data.sender]) unreadDMs[data.sender] = 0;
                unreadDMs[data.sender]++;
                
                // Add to saved DMs if new
                if (!savedDMs.includes(data.sender)) {
                    savedDMs.push(data.sender);
                    localStorage.setItem('openDMs', JSON.stringify(savedDMs));
                }
                
                const audio = document.getElementById('notify-sound');
                if(audio) audio.play().catch(e => console.log("Audio blocked"));
                
                renderDMs(); // Update sidebar
            });

            socket.on('update user list', (users) => {
                const list = document.getElementById('users-list');
                list.innerHTML = ''; 
                users.forEach(user => {
                    if (user === username) return; 
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.style.cursor = "pointer";
                    li.style.padding = "5px 10px";
                    
                    li.onclick = () => {
                        startDM(user);
                    };
                    
                    li.innerHTML = `<span style="display:flex; align-items:center;"><span style="font-size: 1.2em; margin-right: 5px;">üí¨</span> ${user}</span>`;
                    li.onmouseover = () => { li.style.backgroundColor = '#35373c'; };
                    li.onmouseout = () => { li.style.backgroundColor = 'transparent'; };
                    list.appendChild(li);
                });
            });

            socket.on('display typing', (data) => {
                const typingDiv = document.getElementById('typing-indicator');
                typingDiv.innerText = `${data.user} is typing...`;
                setTimeout(() => { typingDiv.innerText = ''; }, 3000);
            });

            const input = document.getElementById('message-input');
            const container = document.getElementById('message-container');

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && input.value) {
                    const messageData = {
                        user: username, 
                        text: input.value,
                        avatar: avatar,
                        replyTo: replyingTo
                    };
                    socket.emit('chat message', messageData);

                    input.value = '';
                    cancelReply(); 
                }
            });

            input.addEventListener('input', () => {
                socket.emit('typing', { user: username, room: currentRoom });
            });

            window.sendReaction = function(messageId, emoji) {
                socket.emit('add reaction', { messageId, emoji });
            }
            window.toggleSidebar = function() { document.querySelector('.servers-list').classList.toggle('active'); }
            window.deleteMessage = function(id) { if(confirm("Delete this?")) socket.emit('delete message', id); }
            window.scrollToMessage = function(id) {
                const element = document.getElementById(`msg-${id}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.classList.add('message-highlight');
                    setTimeout(() => { element.classList.remove('message-highlight'); }, 2000);
                } else {
                    alert("Message too old or not loaded!");
                }
            }
            
            window.createRoom = async function() {
                const name = prompt("Enter room name (letters only):");
                if (name) {
                    await fetch('/rooms', { 
                        method: 'POST', 
                        headers: getAuthHeaders(), 
                        body: JSON.stringify({ name }) 
                    });
                }
            }
            
            window.addRoomToSidebar = function(name) {
                const list = document.getElementById('rooms-list');
                const li = document.createElement('li');
                li.className = 'server-name';
                li.innerHTML = `<a href="#" onclick="joinRoom('${name}')"># ${name}</a>`;
                list.appendChild(li);
            }

            async function loadRooms() {
                const res = await fetch('/rooms', { 
                    headers: getAuthHeaders() 
                });
                const rooms = await res.json();
                document.getElementById('rooms-list').innerHTML = '';
                rooms.forEach(room => addRoomToSidebar(room.name));
            }
            loadRooms();
            
            // Initial DM Render
            renderDMs();
        </script>
    </body>
</html>
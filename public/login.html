<!DOCTYPE html>
<html>
<head>
    <title>Login - DihCord</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="display: flex; justify-content: center; align-items: center; background: #0f172a;">

    <div style="background: #1e293b; padding: 40px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <h2 style="color: #f8fafc; margin-bottom: 20px;">Welcome Back!</h2>
        
        <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 2px solid #334155; background: #0f172a; color: white; outline: none;">
        <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 10px; border: 2px solid #334155; background: #0f172a; color: white; outline: none;">
        
        <div id="register-only" style="display:none; margin-bottom: 20px;">
            <label for="avatar-input" style="cursor: pointer; display: block; color: #949ba4; font-size: 0.9em; margin-bottom: 5px;">
                ðŸ“¸ Upload Profile Picture (Optional)
            </label>
            <input type="file" id="avatar-input" accept="image/*" style="width: 100%; color: #949ba4;">
        </div>

        <button id="main-btn" onclick="login()" style="width: 100%; padding: 15px; background: #8b5cf6; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s;">Log In</button>
        
        <p style="color: #64748b; margin-top: 20px; font-size: 0.9em;">
            <span id="toggle-text">Need an account?</span> 
            <a href="#" onclick="toggleMode()" style="color: #8b5cf6; text-decoration: none; font-weight: bold;">Register</a>
        </p>
        <p id="error-msg" style="color: #ef4444; display: none; margin-top: 10px;"></p>
    </div>

    <script>
        let isRegistering = false;

        function toggleMode() {
            isRegistering = !isRegistering;
            const btn = document.getElementById('main-btn');
            const regDiv = document.getElementById('register-only');
            const toggleText = document.getElementById('toggle-text');
            
            if (isRegistering) {
                btn.innerText = "Create Account";
                btn.onclick = register;
                regDiv.style.display = 'block';
                toggleText.innerHTML = "Already have an account?";
            } else {
                btn.innerText = "Log In";
                btn.onclick = login;
                regDiv.style.display = 'none';
                toggleText.innerHTML = "Need an account?";
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();
            if (data.success) {
                // SAVE TOKEN SECURELY
                localStorage.setItem('token', data.token); // <--- NEW
                localStorage.setItem('username', data.username);
                localStorage.setItem('avatar', data.avatar);
                window.location.href = '/';
            } else {
                showError(data.message);
            }
        }

        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const fileInput = document.getElementById('avatar-input');
            
            let avatarUrl = null;

            // 1. Upload Image First (if selected)
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('avatar', fileInput.files[0]);

                try {
                    const uploadRes = await fetch('/upload-avatar', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadRes.json();
                    if (uploadData.success) {
                        avatarUrl = uploadData.filePath;
                    }
                } catch (err) {
                    console.error("Upload failed", err);
                }
            }

            // 2. Register User with Avatar URL
            const res = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, avatar: avatarUrl })
            });

            const data = await res.json();
            if (data.success) {
                alert("Account created! Please log in.");
                toggleMode(); // Switch back to login
            } else {
                showError(data.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
        }
    </script>
</body>
</html>